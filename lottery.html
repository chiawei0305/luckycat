<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å†°é›ªé¢è†œæ‰“å¡æŠ½çæ´»å‹•ï¼</title>
    <style>
        /* --- è¦–è¦ºé¢¨æ ¼è¨­å®š (ç¶­æŒæš—é»‘ç§‘æŠ€é¢¨) --- */
        body {
            background-color: #0f0f13;
            background-image: radial-gradient(circle at center, #1a1a24 0%, #000 100%);
            color: #ffffff;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* æ¨™é¡Œå€ */
        header {
            text-align: center;
            z-index: 10;
            margin-bottom: 30px;
        }
        h1 {
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            font-size: 2.8rem;
            margin: 0 0 10px 0;
            letter-spacing: 3px;
        }
        .subtitle {
            color: #aaa;
            font-size: 1.1rem;
            background: rgba(255, 215, 0, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }

        /* é€šç”¨é¢æ¿æ¨£å¼ */
        .panel {
            background: rgba(30, 30, 40, 0.8);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            text-align: center;
            width: 90%;
            max-width: 700px;
            transition: all 0.3s ease;
        }

        /* è¨­å®šèˆ‡è¼¸å…¥å€ */
        #setupPanel textarea {
            width: 100%;
            height: 120px;
            background: #222;
            color: #ddd;
            border: 1px solid #444;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-family: monospace;
            resize: vertical;
        }
        .input-group { margin: 15px 0; color: #ccc; }
        .input-group input {
            background: #222; border: 1px solid #555; color: #ffd700;
            padding: 8px; border-radius: 5px; width: 70px; text-align: center; font-size: 1.1rem; font-weight: bold;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            border: none; padding: 15px 50px; color: #000; font-size: 1.3rem; font-weight: 900;
            border-radius: 50px; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
            outline: none;
        }
        .btn-gold:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5); }
        .btn-gold:active { transform: translateY(1px); }
        .btn-secondary {
            background: transparent; border: 2px solid #555; color: #ccc; padding: 10px 30px;
            border-radius: 30px; cursor: pointer; font-size: 1rem; margin-top: 20px; transition: all 0.2s;
        }
        .btn-secondary:hover { border-color: #ccc; color: #fff; background: rgba(255,255,255,0.1); }

        /* æŠ½çä¸»èˆå° */
        #stagePanel { display: none; flex-direction: column; align-items: center; }

        /* æ»¾å‹•è¦–çª— (è€è™æ©Ÿæ•ˆæœ) */
        .roller-container {
            width: 100%;
            height: 180px;
            background: linear-gradient(180deg, #000 0%, #1a1a1a 50%, #000 100%);
            border-top: 3px solid #cba300;
            border-bottom: 3px solid #cba300;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 30px;
            position: relative; overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }
        #currentName {
            font-size: 4rem; font-weight: 900; color: #555;
            transition: color 0.1s, text-shadow 0.1s, transform 0.1s;
        }
        /* ä¸­çæ™‚çš„é«˜äº®æ¨£å¼ */
        .highlight {
            color: #ffd700 !important;
            text-shadow: 0 0 40px rgba(255, 215, 0, 1), 0 0 10px #fff;
            transform: scale(1.1);
        }

        /* é€²åº¦æ¢ */
        .progress-info { font-size: 1.2rem; color: #aaa; margin-bottom: 25px; }
        .progress-count { color: #ffd700; font-weight: bold; font-size: 1.5rem; }

        /* å³æ™‚ä¸­çåå–®å±•ç¤ºå€ (æŠ½çéç¨‹ç”¨) */
        .live-winners-grid {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;
            width: 100%; max-height: 350px; overflow-y: auto; padding: 10px;
            /* éš±è—å·è»¸ */
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .live-winners-grid::-webkit-scrollbar { display: none; }
        
        /* å€‹åˆ¥ä¸­çå¡ç‰‡ (æŠ½çéç¨‹) */
        .winner-card-live {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 215, 0, 0.2);
            padding: 8px 20px; border-radius: 30px; font-size: 1.1rem;
            animation: slideUp 0.4s ease-out forwards;
            opacity: 0; transform: translateY(20px);
            display: flex; align-items: center; gap: 10px;
        }
        .winner-card-live.new { background: rgba(255, 215, 0, 0.3); border-color: #ffd700; }
        .rank-badge {
            background: #ffd700; color: #000; width: 28px; height: 28px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 0.9rem; font-weight: 900; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* æœ€çµ‚çµ±è¨ˆé¢æ¿ */
        #summaryPanel { display: none; }
        .summary-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 30px;
            max-height: 500px;
            overflow-y: auto;
        }
        .summary-card {
            background: linear-gradient(45deg, rgba(255,215,0,0.1), rgba(255,215,0,0.05));
            border: 1px solid #ffd700;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.2rem;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.8s ease forwards;
        }
        .prize-count { color: #ffd700; font-weight: bold; font-size: 1.4rem; margin-left: 10px;}

        /* å‹•ç•«å®šç¾© */
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <header>
        <h1>âœ¨ å†°é›ªé¢è†œæ‰“å¡æŠ½çæ´»å‹•ï¼ âœ¨</h1>
        <div class="subtitle" id="headerStats">æº–å‚™ä¸­...</div>
    </header>

    <div id="setupPanel" class="panel">
        <h2>æ­¥é©Ÿ 1: è³‡æ–™åŒ¯å…¥ (å¾Œå°)</h2>
        <p style="color:#888; font-size:0.9rem;">å§“åèˆ‡ç¥¨æ•¸<br><strong></strong></p>
        <textarea id="inputData" placeholder="ä¾‹å¦‚ï¼š
é™³é›…éˆ´	30
Hazel	30
å°ç”œå¿ƒ	29"></textarea>
        <div class="input-group">
            <label>é è¨ˆæŠ½å‡ºçé …æ•¸é‡ï¼š</label>
            <input type="number" id="winnerCountTarget" value="38" min="1">
        </div>
        <button class="btn-gold" onclick="initLottery()">é–å®šåå–®ä¸¦å‰å¾€èˆå°</button>
    </div>

    <div id="stagePanel" class="panel">
        <div class="roller-container">
            <div id="currentName">READY</div>
        </div>

        <div class="progress-info">
            æŠ½çé€²åº¦: <span class="progress-count" id="drawnCount">0</span> / <span id="totalTargetDisplay">38</span>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn-gold" onclick="startDrawCycle()">ğŸ¬ é–‹å§‹é€£çºŒæŠ½ç</button>
            <button id="viewSummaryBtn" class="btn-gold" style="display:none;" onclick="showSummary()">ğŸ“Š æŸ¥çœ‹æœ€çµ‚ç²ççµ±è¨ˆ</button>
        </div>

        <div class="live-winners-grid" id="liveWinnersList">
            </div>
    </div>

    <div id="summaryPanel" class="panel">
        <h2 style="color:#ffd700">ğŸ‰ æœ€çµ‚ç²çåå–®çµ±è¨ˆ ğŸ‰</h2>
        <p>æ­å–œä»¥ä¸‹å¹¸é‹å¾—ä¸»ç²å¾—é¢è†œï¼</p>
        
        <div class="summary-list" id="summaryGrid">
            </div>

        <button class="btn-secondary" onclick="exportSummaryCSV()">åŒ¯å‡ºçµ±è¨ˆ CSV</button>
    </div>

    <script>
        // --- æ ¸å¿ƒé‚è¼¯ (JavaScript) ---
        
        let ticketPool = []; // ç¥¨å€‰ (åŒ…å«é‡è¤‡åå­—çš„é™£åˆ—)
        let totalWinnersNeeded = 38;
        let winnersSequence = []; // ç´€éŒ„ä¸­çé †åºçš„é™£åˆ— (å­˜å§“å)
        let isDrawing = false;
        
        // åˆå§‹åŒ–ï¼šè®€å–è³‡æ–™ä¸¦å»ºç«‹ç¥¨å€‰
        function initLottery() {
            const rawText = document.getElementById('inputData').value.trim();
            totalWinnersNeeded = parseInt(document.getElementById('winnerCountTarget').value);
            
            if (!rawText) { alert("è«‹è¼¸å…¥è³‡æ–™ï¼"); return; }
            if (totalWinnersNeeded <= 0) { alert("æŠ½å‡ºæ•¸é‡å¿…é ˆå¤§æ–¼ 0ï¼"); return; }
            
            ticketPool = [];
            let participantCount = 0;
            
            const rows = rawText.split('\n');
            rows.forEach(row => {
                // ç›¸å®¹ Tab æˆ–é€—è™Ÿ/ç©ºç™½åˆ†éš”
                let parts = row.split(/\t|[,\s]+/);
                // ç°¡å–®éæ¿¾ç©ºè¡Œ
                if (parts.length >= 2) {
                    let name = parts[0].trim();
                    // å˜—è©¦æŠ“å–æœ€å¾Œä¸€å€‹éƒ¨åˆ†ç•¶ä½œæ•¸å­—
                    let tickets = parseInt(parts[parts.length-1]); 
                    
                    if (name && !isNaN(tickets) && tickets > 0) {
                        // ã€æ ¸å¿ƒç®—æ³•ã€‘ä¾ç…§ç¥¨æ•¸å°‡åå­—é‡è¤‡åŠ å…¥ç¥¨å€‰
                        for (let i = 0; i < tickets; i++) {
                            ticketPool.push(name);
                        }
                        participantCount++;
                    }
                }
            });

            if (ticketPool.length < totalWinnersNeeded) {
                alert(`éŒ¯èª¤ï¼šç¸½ç¥¨æ•¸ (${ticketPool.length}) å°‘æ–¼ é è¨ˆæŠ½å‡ºäººæ•¸ (${totalWinnersNeeded})ï¼`);
                return;
            }

            // åˆ‡æ›ä»‹é¢
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('stagePanel').style.display = 'flex';
            
            // æ›´æ–° header çš„çµ±è¨ˆè³‡è¨Š (éš±ç§å®‰å…¨ï¼Œåªé¡¯ç¤ºç¸½æ•¸)
            document.getElementById('headerStats').innerText = `ç¸½åƒèˆ‡äººæ•¸ï¼š${participantCount} äºº | é¢è†œæ‰“å¡ç¸½æ•¸ï¼š${ticketPool.length}`;
            document.getElementById('totalTargetDisplay').innerText = totalWinnersNeeded;
        }

        // é–‹å§‹è‡ªå‹•æŠ½çæµç¨‹
        async function startDrawCycle() {
            if (isDrawing) return;
            document.getElementById('startBtn').style.display = 'none';
            isDrawing = true;
            
            // å•Ÿå‹•éè¿´æŠ½ç
            await drawNextWinner();
        }

        // æŠ½ä¸€ä½ä¸­çè€…çš„éåŒæ­¥å‡½æ•¸
        async function drawNextWinner() {
            if (winnersSequence.length >= totalWinnersNeeded) {
                finishDrawProcess();
                return;
            }

            const nameDisplay = document.getElementById('currentName');
            nameDisplay.classList.remove('highlight');
            nameDisplay.style.color = "#555";

            // A. æ»¾å‹•å‹•ç•«æ•ˆæœ (å¢åŠ ç·Šå¼µæ„Ÿ)
            let rollDuration = 300; // æ»¾å‹•æ™‚é–“ (æ¯«ç§’) - æƒ³è¦å¿«ä¸€é»å¯ä»¥ç¸®çŸ­é€™è£¡
            let steps = 10; // è®Šæ›å¹¾æ¬¡åå­—
            
            for (let i = 0; i < steps; i++) {
                let randomPreview = ticketPool[Math.floor(Math.random() * ticketPool.length)];
                nameDisplay.innerText = randomPreview;
                // æš«åœä¸€å°æ®µæ™‚é–“è£½é€ è¦–è¦ºæ®˜ç•™
                await new Promise(r => setTimeout(r, rollDuration / steps));
            }

            // B. ã€æ ¸å¿ƒæŠ½ç±¤ã€‘æ±ºå®šä¸­çè€…
            let winningIndex = Math.floor(Math.random() * ticketPool.length);
            let winnerName = ticketPool[winningIndex];
            
            // é‡è¦ï¼šæŠ½å‡ºå¾Œï¼Œè©²å¼µç¥¨ä½œå»¢ (å¾æ± ä¸­ç§»é™¤)ï¼Œä½†è©²äººçš„å…¶ä»–ç¥¨é‚„åœ¨ (å¯é‡è¤‡ä¸­ç)
            ticketPool.splice(winningIndex, 1);
            winnersSequence.push(winnerName);

            // C. é¡¯ç¤ºä¸­ççµæœ
            nameDisplay.innerText = winnerName;
            nameDisplay.classList.add('highlight');
            
            // æ›´æ–°ä¸‹æ–¹åˆ—è¡¨å’Œé€²åº¦
            updateLiveWinnersList(winnerName);
            document.getElementById('drawnCount').innerText = winnersSequence.length;

            // æš«åœä¸€ä¸‹è®“å¤§å®¶çœ‹æ¸…æ¥šæ˜¯èª°ä¸­ç (500ms)
            await new Promise(r => setTimeout(r, 500));
            
            // ç¹¼çºŒæŠ½ä¸‹ä¸€ä½
            drawNextWinner();
        }

        // æ›´æ–°æŠ½çéç¨‹ä¸­çš„å³æ™‚åå–® (åªé¡¯ç¤ºå§“åèˆ‡é †åº)
        function updateLiveWinnersList(name) {
            const list = document.getElementById('liveWinnersList');
            const rank = winnersSequence.length;
            
            const div = document.createElement('div');
            div.className = 'winner-card-live new';
            // é€™è£¡åˆ»æ„ä¸é¡¯ç¤ºç´¯ç©æ¬¡æ•¸ï¼Œä¿æŒéç¨‹å–®ç´”
            div.innerHTML = `<div class="rank-badge">${rank}</div> ${name}`;
            
            // æ’å…¥åˆ°æœ€å‰é¢ (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
            list.insertBefore(div, list.firstChild);
            
            // ç§»é™¤æ–°åŠ å…¥çš„ç‰¹æ•ˆæ¨£å¼
            setTimeout(() => div.classList.remove('new'), 500);
        }

        // æŠ½ççµæŸè™•ç†
        function finishDrawProcess() {
            isDrawing = false;
            document.getElementById('currentName').innerText = "ğŸ‰ å·²å…¨æ•¸æŠ½å‡º ğŸ‰";
            document.getElementById('currentName').style.color = "#ffd700";
            // é¡¯ç¤ºæŸ¥çœ‹çµ±è¨ˆæŒ‰éˆ•
            document.getElementById('viewSummaryBtn').style.display = 'inline-block';
        }

        // --- æœ€çµ‚çµ±è¨ˆç›¸é—œå‡½æ•¸ ---

        // é¡¯ç¤ºçµ±è¨ˆé¢æ¿
        function showSummary() {
            // éš±è—èˆå°ï¼Œé¡¯ç¤ºçµ±è¨ˆ
            document.getElementById('stagePanel').style.display = 'none';
            document.getElementById('summaryPanel').style.display = 'block';
            document.getElementById('headerStats').innerText = "ç²ççµ±è¨ˆçµæœ";

            // è¨ˆç®—æ¯å€‹äººä¸­çæ¬¡æ•¸
            let summaryCounts = {};
            winnersSequence.forEach(name => {
                summaryCounts[name] = (summaryCounts[name] || 0) + 1;
            });

            const grid = document.getElementById('summaryGrid');
            grid.innerHTML = ''; // æ¸…ç©º

            // ç”¢ç”Ÿçµ±è¨ˆå¡ç‰‡
            for (let [name, count] of Object.entries(summaryCounts)) {
                let card = document.createElement('div');
                card.className = 'summary-card';
                // ç¬¦åˆä½¿ç”¨è€…è¦æ±‚çš„æ ¼å¼
                card.innerHTML = `<span>${name}</span> <div>å…±ç²å¾— <span class="prize-count">${count}</span> ç‰‡é¢è†œ</div>`;
                grid.appendChild(card);
            }
        }

        // åŒ¯å‡º CSV åŠŸèƒ½ (çµ¦ä¸»è¾¦æ–¹å­˜æª”ç”¨)
        function exportSummaryCSV() {
            let summaryCounts = {};
            winnersSequence.forEach(name => {
                summaryCounts[name] = (summaryCounts[name] || 0) + 1;
            });

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM
            csvContent += "å§“å,ç¸½ç²çæ•¸(é¢è†œç‰‡æ•¸)\n";
            
            for (let [name, count] of Object.entries(summaryCounts)) {
                 csvContent += `${name},${count}\n`;
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "æœ€çµ‚ç²ççµ±è¨ˆ.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>